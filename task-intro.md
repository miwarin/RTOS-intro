# タスク

* タスクとは、複数の処理を並行処理するためのもの。
  * 並行に処理する必要がなければタスクを使う必要はない
  * OS がタスクを制御する
  * 優先度によってどのタスクを実行するか制御される
  * タスクとしての処理をおこなうものをタスクエントリーと呼ぶ。ようするに関数である。
  * OS の制御により、このタスクエントリーが呼ばれる。

* タスク生成
  * cre_tsk を使う
  * タスクエントリーに注意
    * OS がディスパッチするとタスクエントリーが呼ばれる。
    * READY→RUNNING と状態遷移する
    * タスクエントリー内では(長時間)CPUを占有するようなことをしてはいけない
    * for(;;){ レジスタ読んで確認 } のようなことをしてはいけない。
    * 他のタスクが CPU を使えなくなる。
    * 迅速に処理しとっとと終了すべし
  * 優先度に注意
    * ハードウェアに近いタスクほど高優先度
    * そうでないタスクが低優先度
    * カメラ全体を考慮して優先度が決定されるので、勝手に優先度を設定しないこと。
  * スタックサイズに注意
    * スタックサイズはタスクが利用できるメモリ
    * 自動変数や関数呼び出しの引数を記憶したりする
    * カメラではスタックサイズはデフォルトで4096バイト
    * 大きすぎる自動変数(配列とか)を作ったり、関数呼び出しが深すぎるとスタックオーバーフローする
    * スタックオーバーフローしてもカメラはASSERTしたりPanicなどしない。
    * 原因調査しづらい非常に厄介な現象となるので注意

* タスク終了
  * ExitTask を使う (タスクエントリー内で呼ぶ)
  * タスク終了するときは ExitTask すべし

* タスク情報
  * chg_pri 優先度変更
  * ref_tsk タスク状態参照
  * slp_tsk タスクを WAIT へ状態遷移させる
  *  wup_tsk タスクを READY へ状態遷移させる

* 状態遷移
  * タスクは複数の状態がある
  * READY <=> RUNNING は OS によって遷移される
  * RUNNING => WAITING => READY は タスクがみずから状態遷移させる
  * RUNNING => DORMANT も然り

[RTOS-intro/task-state.PNG at master · miwarin/RTOS-intro](https://github.com/miwarin/RTOS-intro/blob/master/task-state.PNG "RTOS-intro/task-state.PNG at master · miwarin/RTOS-intro")
